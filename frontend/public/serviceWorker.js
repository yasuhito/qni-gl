(function () {
    'use strict';

    /******************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
    /* global Reflect, Promise, SuppressedError, Symbol */


    function __awaiter(thisArg, _arguments, P, generator) {
        function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
        return new (P || (P = Promise))(function (resolve, reject) {
            function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
            function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
            function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
            step((generator = generator.apply(thisArg, _arguments || [])).next());
        });
    }

    function __generator(thisArg, body) {
        var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
        return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
        function verb(n) { return function (v) { return step([n, v]); }; }
        function step(op) {
            if (f) throw new TypeError("Generator is already executing.");
            while (g && (g = 0, op[0] && (_ = 0)), _) try {
                if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
                if (y = 0, t) op = [op[0] & 2, t.value];
                switch (op[0]) {
                    case 0: case 1: t = op; break;
                    case 4: _.label++; return { value: op[1], done: false };
                    case 5: _.label++; y = op[1]; op = [0]; continue;
                    case 7: op = _.ops.pop(); _.trys.pop(); continue;
                    default:
                        if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                        if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                        if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                        if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                        if (t[2]) _.ops.pop();
                        _.trys.pop(); continue;
                }
                op = body.call(thisArg, _);
            } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
            if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
        }
    }

    typeof SuppressedError === "function" ? SuppressedError : function (error, suppressed, message) {
        var e = new Error(message);
        return e.name = "SuppressedError", e.error = error, e.suppressed = suppressed, e;
    };

    (undefined && undefined.__spreadArray) || function (to, from, pack) {
        if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
                if (!ar) ar = Array.prototype.slice.call(from, 0, i);
                ar[i] = from[i];
            }
        }
        return to.concat(ar || Array.prototype.slice.call(from));
    };
    /**
     * Return a `NonEmptyArray` of length `n` with element `i` initialized with `f(i)`.
     *
     * **Note**. `n` is normalized to a natural number.
     *
     * @example
     * import { makeBy } from 'fp-ts/NonEmptyArray'
     * import { pipe } from 'fp-ts/function'
     *
     * const double = (n: number): number => n * 2
     * assert.deepStrictEqual(pipe(5, makeBy(double)), [0, 2, 4, 6, 8])
     *
     * @category constructors
     * @since 2.11.0
     */
    var makeBy = function (f) {
        return function (n) {
            var j = Math.max(0, Math.floor(n));
            var out = [f(0)];
            for (var i = 1; i < j; i++) {
                out.push(f(i));
            }
            return out;
        };
    };
    /**
     * Create a `NonEmptyArray` containing a range of integers, including both endpoints.
     *
     * @example
     * import { range } from 'fp-ts/NonEmptyArray'
     *
     * assert.deepStrictEqual(range(1, 5), [1, 2, 3, 4, 5])
     *
     * @category constructors
     * @since 2.11.0
     */
    var range = function (start, end) {
        return start <= end ? makeBy(function (i) { return start + i; })(end - start + 1) : [start];
    };

    var Ht=Object.create;var et=Object.defineProperty;var Yt=Object.getOwnPropertyDescriptor;var Jt=Object.getOwnPropertyNames;var Kt=Object.getPrototypeOf,tr=Object.prototype.hasOwnProperty;var rr=(s,r)=>()=>(r||s((r={exports:{}}).exports,r),r.exports);var er=(s,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of Jt(r))!tr.call(s,i)&&i!==t&&et(s,i,{get:()=>r[i],enumerable:!(e=Yt(r,i))||e.enumerable});return s};var ir=(s,r,t)=>(t=s!=null?Ht(Kt(s)):{},er(!s||!s.__esModule?et(t,"default",{value:s,enumerable:!0}):t,s));var nt=rr((X,it)=>{(function(s){var r=2e3,t={s:1,n:0,d:1};function e(a,o){if(isNaN(a=parseInt(a,10)))throw d.InvalidParameter;return a*o}function i(a,o){if(o===0)throw d.DivisionByZero;var u=Object.create(d.prototype);u.s=a<0?-1:1,a=a<0?-a:a;var l=w(a,o);return u.n=a/l,u.d=o/l,u}function n(a){for(var o={},u=a,l=2,c=4;c<=u;){for(;u%l===0;)u/=l,o[l]=(o[l]||0)+1;c+=1+2*l++;}return u!==a?u>1&&(o[u]=(o[u]||0)+1):o[a]=(o[a]||0)+1,o}var h=function(a,o){var u=0,l=1,c=1,v=0,g=0,N=0,M=1,T=1,m=0,p=1,O=1,C=1,G=1e7,F;if(a!=null)if(o!==void 0){if(u=a,l=o,c=u*l,u%1!==0||l%1!==0)throw d.NonIntegerParameter}else switch(typeof a){case"object":{if("d"in a&&"n"in a)u=a.n,l=a.d,"s"in a&&(u*=a.s);else if(0 in a)u=a[0],1 in a&&(l=a[1]);else throw d.InvalidParameter;c=u*l;break}case"number":{if(a<0&&(c=a,a=-a),a%1===0)u=a;else if(a>0){for(a>=1&&(T=Math.pow(10,Math.floor(1+Math.log(a)/Math.LN10)),a/=T);p<=G&&C<=G;)if(F=(m+O)/(p+C),a===F){p+C<=G?(u=m+O,l=p+C):C>p?(u=O,l=C):(u=m,l=p);break}else a>F?(m+=O,p+=C):(O+=m,C+=p),p>G?(u=O,l=C):(u=m,l=p);u*=T;}else (isNaN(a)||isNaN(o))&&(l=u=NaN);break}case"string":{if(p=a.match(/\d+|./g),p===null)throw d.InvalidParameter;if(p[m]==="-"?(c=-1,m++):p[m]==="+"&&m++,p.length===m+1?g=e(p[m++],c):p[m+1]==="."||p[m]==="."?(p[m]!=="."&&(v=e(p[m++],c)),m++,(m+1===p.length||p[m+1]==="("&&p[m+3]===")"||p[m+1]==="'"&&p[m+3]==="'")&&(g=e(p[m],c),M=Math.pow(10,p[m].length),m++),(p[m]==="("&&p[m+2]===")"||p[m]==="'"&&p[m+2]==="'")&&(N=e(p[m+1],c),T=Math.pow(10,p[m+1].length)-1,m+=3)):p[m+1]==="/"||p[m+1]===":"?(g=e(p[m],c),M=e(p[m+2],1),m+=3):p[m+3]==="/"&&p[m+1]===" "&&(v=e(p[m],c),g=e(p[m+2],c),M=e(p[m+4],1),m+=5),p.length<=m){l=M*T,c=u=N+l*v+T*g;break}}default:throw d.InvalidParameter}if(l===0)throw d.DivisionByZero;t.s=c<0?-1:1,t.n=Math.abs(u),t.d=Math.abs(l);};function b(a,o,u){for(var l=1;o>0;a=a*a%u,o>>=1)o&1&&(l=l*a%u);return l}function y(a,o){for(;o%2===0;o/=2);for(;o%5===0;o/=5);if(o===1)return 0;for(var u=10%o,l=1;u!==1;l++)if(u=u*10%o,l>r)return 0;return l}function f(a,o,u){for(var l=1,c=b(10,u,o),v=0;v<300;v++){if(l===c)return v;l=l*10%o,c=c*10%o;}return 0}function w(a,o){if(!a)return o;if(!o)return a;for(;;){if(a%=o,!a)return o;if(o%=a,!o)return a}}function d(a,o){if(h(a,o),this instanceof d)a=w(t.d,t.n),this.s=t.s,this.n=t.n/a,this.d=t.d/a;else return i(t.s*t.n,t.d)}d.DivisionByZero=new Error("Division by Zero"),d.InvalidParameter=new Error("Invalid argument"),d.NonIntegerParameter=new Error("Parameters must be integer"),d.prototype={s:1,n:0,d:1,abs:function(){return i(this.n,this.d)},neg:function(){return i(-this.s*this.n,this.d)},add:function(a,o){return h(a,o),i(this.s*this.n*t.d+t.s*this.d*t.n,this.d*t.d)},sub:function(a,o){return h(a,o),i(this.s*this.n*t.d-t.s*this.d*t.n,this.d*t.d)},mul:function(a,o){return h(a,o),i(this.s*t.s*this.n*t.n,this.d*t.d)},div:function(a,o){return h(a,o),i(this.s*t.s*this.n*t.d,this.d*t.n)},clone:function(){return i(this.s*this.n,this.d)},mod:function(a,o){if(isNaN(this.n)||isNaN(this.d))return new d(NaN);if(a===void 0)return i(this.s*this.n%this.d,1);if(h(a,o),t.n===0&&this.d===0)throw d.DivisionByZero;return i(this.s*(t.d*this.n)%(t.n*this.d),t.d*this.d)},gcd:function(a,o){return h(a,o),i(w(t.n,this.n)*w(t.d,this.d),t.d*this.d)},lcm:function(a,o){return h(a,o),t.n===0&&this.n===0?i(0,1):i(t.n*this.n,w(t.n,this.n)*w(t.d,this.d))},ceil:function(a){return a=Math.pow(10,a||0),isNaN(this.n)||isNaN(this.d)?new d(NaN):i(Math.ceil(a*this.s*this.n/this.d),a)},floor:function(a){return a=Math.pow(10,a||0),isNaN(this.n)||isNaN(this.d)?new d(NaN):i(Math.floor(a*this.s*this.n/this.d),a)},round:function(a){return a=Math.pow(10,a||0),isNaN(this.n)||isNaN(this.d)?new d(NaN):i(Math.round(a*this.s*this.n/this.d),a)},inverse:function(){return i(this.s*this.d,this.n)},pow:function(a,o){if(h(a,o),t.d===1)return t.s<0?i(Math.pow(this.s*this.d,t.n),Math.pow(this.n,t.n)):i(Math.pow(this.s*this.n,t.n),Math.pow(this.d,t.n));if(this.s<0)return null;var u=n(this.n),l=n(this.d),c=1,v=1;for(var g in u)if(g!=="1"){if(g==="0"){c=0;break}if(u[g]*=t.n,u[g]%t.d===0)u[g]/=t.d;else return null;c*=Math.pow(g,u[g]);}for(var g in l)if(g!=="1"){if(l[g]*=t.n,l[g]%t.d===0)l[g]/=t.d;else return null;v*=Math.pow(g,l[g]);}return t.s<0?i(v,c):i(c,v)},equals:function(a,o){return h(a,o),this.s*this.n*t.d===t.s*t.n*this.d},compare:function(a,o){h(a,o);var u=this.s*this.n*t.d-t.s*t.n*this.d;return (0<u)-(u<0)},simplify:function(a){if(isNaN(this.n)||isNaN(this.d))return this;a=a||.001;for(var o=this.abs(),u=o.toContinued(),l=1;l<u.length;l++){for(var c=i(u[l-1],1),v=l-2;v>=0;v--)c=c.inverse().add(u[v]);if(c.sub(o).abs().valueOf()<a)return c.mul(this.s)}return this},divisible:function(a,o){return h(a,o),!(!(t.n*this.d)||this.n*t.d%(t.n*this.d))},valueOf:function(){return this.s*this.n/this.d},toFraction:function(a){var o,u="",l=this.n,c=this.d;return this.s<0&&(u+="-"),c===1?u+=l:(a&&(o=Math.floor(l/c))>0&&(u+=o,u+=" ",l%=c),u+=l,u+="/",u+=c),u},toLatex:function(a){var o,u="",l=this.n,c=this.d;return this.s<0&&(u+="-"),c===1?u+=l:(a&&(o=Math.floor(l/c))>0&&(u+=o,l%=c),u+="\\frac{",u+=l,u+="}{",u+=c,u+="}"),u},toContinued:function(){var a,o=this.n,u=this.d,l=[];if(isNaN(o)||isNaN(u))return l;do l.push(Math.floor(o/u)),a=o%u,o=u,u=a;while(o!==1);return l},toString:function(a){var o=this.n,u=this.d;if(isNaN(o)||isNaN(u))return "NaN";a=a||15;var l=y(o,u),c=f(o,u,l),v=this.s<0?"-":"";if(v+=o/u|0,o%=u,o*=10,o&&(v+="."),l){for(var g=c;g--;)v+=o/u|0,o%=u,o*=10;v+="(";for(var g=l;g--;)v+=o/u|0,o%=u,o*=10;v+=")";}else for(var g=a;o&&g--;)v+=o/u|0,o%=u,o*=10;return v}},typeof define=="function"&&define.amd?define([],function(){return d}):typeof X=="object"?(Object.defineProperty(d,"__esModule",{value:!0}),d.default=d,d.Fraction=d,it.exports=d):s.Fraction=d;})(X);});var lt=ir(nt());function H(s,r,t,e){function i(n){return n instanceof t?n:new t(function(h){h(n);})}return new(t||(t=Promise))(function(n,h){function b(w){try{f(e.next(w));}catch(d){h(d);}}function y(w){try{f(e.throw(w));}catch(d){h(d);}}function f(w){w.done?n(w.value):i(w.value).then(b,y);}f((e=e.apply(s,[])).next());})}function Y(s,r){var t={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},e,i,n,h;return h={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(h[Symbol.iterator]=function(){return this}),h;function b(f){return function(w){return y([f,w])}}function y(f){if(e)throw new TypeError("Generator is already executing.");for(;t;)try{if(e=1,i&&(n=f[0]&2?i.return:f[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,f[1])).done)return n;switch(i=0,n&&(f=[f[0]&2,n.value]),f[0]){case 0:case 1:n=f;break;case 4:return t.label++,{value:f[1],done:!1};case 5:t.label++,i=f[1],f=[0];continue;case 7:f=t.ops.pop(),t.trys.pop();continue;default:if(n=t.trys,!(n=n.length>0&&n[n.length-1])&&(f[0]===6||f[0]===2)){t=0;continue}if(f[0]===3&&(!n||f[1]>n[0]&&f[1]<n[3])){t.label=f[1];break}if(f[0]===6&&t.label<n[1]){t.label=n[1],n=f;break}if(n&&t.label<n[2]){t.label=n[2],t.ops.push(f);break}n[2]&&t.ops.pop(),t.trys.pop();continue}f=r.call(s,t);}catch(w){f=[6,w],i=0;}finally{e=n=0;}if(f[0]&5)throw f[1];return {value:f[0]?f[1]:void 0,done:!0}}}function Q(s,r){var t=typeof Symbol=="function"&&s[Symbol.iterator];if(!t)return s;var e=t.call(s),i,n=[],h;try{for(;(r===void 0||r-- >0)&&!(i=e.next()).done;)n.push(i.value);}catch(b){h={error:b};}finally{try{i&&!i.done&&(t=e.return)&&t.call(e);}finally{if(h)throw h.error}}return n}function _(s,r,t){if(arguments.length===2)for(var e=0,i=r.length,n;e<i;e++)(n||!(e in r))&&(n||(n=Array.prototype.slice.call(r,0,e)),n[e]=r[e]);return s.concat(n||Array.prototype.slice.call(r))}var nr={withStackTrace:!1},st=function(s,r,t){t===void 0&&(t=nr);var e=r.isOk()?{type:"Ok",value:r.value}:{type:"Err",value:r.error},i=t.withStackTrace?new Error().stack:void 0;return {data:e,message:s,stack:i}},I=function(){function s(r){this._promise=r;}return s.fromSafePromise=function(r){var t=r.then(function(e){return new B(e)});return new s(t)},s.fromPromise=function(r,t){var e=r.then(function(i){return new B(i)}).catch(function(i){return new q(t(i))});return new s(e)},s.combine=function(r){return sr(r)},s.combineWithAllErrors=function(r){return or(r)},s.prototype.map=function(r){var t=this;return new s(this._promise.then(function(e){return H(t,void 0,void 0,function(){var i;return Y(this,function(n){switch(n.label){case 0:return e.isErr()?[2,new q(e.error)]:(i=B.bind,[4,r(e.value)]);case 1:return [2,new(i.apply(B,[void 0,n.sent()]))]}})})}))},s.prototype.mapErr=function(r){var t=this;return new s(this._promise.then(function(e){return H(t,void 0,void 0,function(){var i;return Y(this,function(n){switch(n.label){case 0:return e.isOk()?[2,new B(e.value)]:(i=q.bind,[4,r(e.error)]);case 1:return [2,new(i.apply(q,[void 0,n.sent()]))]}})})}))},s.prototype.andThen=function(r){return new s(this._promise.then(function(t){if(t.isErr())return new q(t.error);var e=r(t.value);return e instanceof s?e._promise:e}))},s.prototype.orElse=function(r){var t=this;return new s(this._promise.then(function(e){return H(t,void 0,void 0,function(){return Y(this,function(i){return e.isErr()?[2,r(e.error)]:[2,new B(e.value)]})})}))},s.prototype.match=function(r,t){return this._promise.then(function(e){return e.match(r,t)})},s.prototype.unwrapOr=function(r){return this._promise.then(function(t){return t.unwrapOr(r)})},s.prototype.then=function(r,t){return this._promise.then(r,t)},s}();var at=function(s){return new I(Promise.resolve(new q(s)))};I.fromPromise;I.fromSafePromise;var ar=function(s){return function(r){return _(_([],Q(r),!1),[s],!1)}},ot=function(s){return s.reduce(function(r,t){return r.isOk()?t.isErr()?S(t.error):r.map(ar(t.value)):r},A([]))},sr=function(s){return I.fromSafePromise(Promise.all(s)).andThen(ot)},ut=function(s){return s.reduce(function(r,t){return t.isErr()?r.isErr()?S(_(_([],Q(r.error),!1),[t.error],!1)):S([t.error]):r.isErr()?r:A(_(_([],Q(r.value),!1),[t.value],!1))},A([]))},or=function(s){return I.fromSafePromise(Promise.all(s)).andThen(ut)},V;(function(s){function r(i,n){return function(){for(var h=[],b=0;b<arguments.length;b++)h[b]=arguments[b];try{var y=i.apply(void 0,_([],Q(h),!1));return A(y)}catch(f){return S(n?n(f):f)}}}s.fromThrowable=r;function t(i){return ot(i)}s.combine=t;function e(i){return ut(i)}s.combineWithAllErrors=e;})(V||(V={}));var A=function(s){return new B(s)},S=function(s){return new q(s)},B=function(){function s(r){this.value=r;}return s.prototype.isOk=function(){return !0},s.prototype.isErr=function(){return !this.isOk()},s.prototype.map=function(r){return A(r(this.value))},s.prototype.mapErr=function(r){return A(this.value)},s.prototype.andThen=function(r){return r(this.value)},s.prototype.orElse=function(r){return A(this.value)},s.prototype.asyncAndThen=function(r){return r(this.value)},s.prototype.asyncMap=function(r){return I.fromSafePromise(r(this.value))},s.prototype.unwrapOr=function(r){return this.value},s.prototype.match=function(r,t){return r(this.value)},s.prototype._unsafeUnwrap=function(r){return this.value},s.prototype._unsafeUnwrapErr=function(r){throw st("Called `_unsafeUnwrapErr` on an Ok",this,r)},s}(),q=function(){function s(r){this.error=r;}return s.prototype.isOk=function(){return !1},s.prototype.isErr=function(){return !this.isOk()},s.prototype.map=function(r){return S(this.error)},s.prototype.mapErr=function(r){return S(r(this.error))},s.prototype.andThen=function(r){return S(this.error)},s.prototype.orElse=function(r){return r(this.error)},s.prototype.asyncAndThen=function(r){return at(this.error)},s.prototype.asyncMap=function(r){return at(this.error)},s.prototype.unwrapOr=function(r){return r},s.prototype.match=function(r,t){return t(this.error)},s.prototype._unsafeUnwrap=function(r){throw st("Called `_unsafeUnwrap` on an Err",this,r)},s.prototype._unsafeUnwrapErr=function(r){return this.error},s}();V.fromThrowable;function j(s){let r=ur(s);return new lt.default(r).valueOf()*Math.PI}function ur(s){return s.replace(/(\d+)π/g,"$1").replace(/π/g,"1")}var ft=[{character:"\xBD",ref:"\xBD",expanded:"1/2",value:.5},{character:"\xBC",ref:"\xBC",expanded:"1/4",value:.25},{character:"\xBE",ref:"\xBE",expanded:"3/4",value:.75},{character:"\u2153",ref:"\u2153",expanded:"1/3",value:.3333333333333333},{character:"\u2154",ref:"\u2154",expanded:"2/3",value:.6666666666666666},{character:"\u2155",ref:"\u2155",expanded:"1/5",value:.2},{character:"\u2156",ref:"\u2156",expanded:"2/5",value:.4},{character:"\u2157",ref:"\u2157",expanded:"3/5",value:.6},{character:"\u2158",ref:"\u2158",expanded:"4/5",value:.8},{character:"\u2159",ref:"\u2159",expanded:"1/6",value:.16666666666666666},{character:"\u215A",ref:"\u215A",expanded:"5/6",value:.8333333333333334},{character:"\u2150",ref:"\u2150",expanded:"1/7",value:.14285714285714285},{character:"\u215B",ref:"\u215B",expanded:"1/8",value:.125},{character:"\u215C",ref:"\u215C",expanded:"3/8",value:.375},{character:"\u215D",ref:"\u215D",expanded:"5/8",value:.625},{character:"\u215E",ref:"\u215E",expanded:"7/8",value:.875},{character:"\u2151",ref:"\u2151",expanded:"1/9",value:.1111111111111111},{character:"\u2152",ref:"\u2152",expanded:"1/10",value:.1}],U=class D{static parseFloat(r){if(r.length===0)throw new Error(`Not a number: '${r}'`);if(r[0]==="-")return -D.parseFloat(r.substr(1));if(r[0]==="\u221A")return Math.sqrt(D.parseFloat(r.substr(1)));let t=D.matchUnicodeFraction(i=>i.character===r);if(t!==void 0)return t.value;let e=parseFloat(r);if(isNaN(e))throw new Error(`Not a number: '${r}'`);return e}static simplifyByRounding(r,t){if(r<0)return -D.simplifyByRounding(-r,t);let e=r%1;if(e<=t||1-e<=t)return Math.round(r);let i=D.matchUnicodeFraction(h=>Math.abs(h.value-r)<=t);if(i!==void 0)return i.value;let n=D.matchUnicodeFraction(h=>Math.abs(Math.sqrt(h.value)-r)<=t);return n!==void 0?Math.sqrt(n.value):r}static matchUnicodeFraction(r){for(let t of ft)if(r(t))return t}constructor(r,t,e,i){this.allowAbbreviation=r,this.maxAbbreviationError=t,this.fixedDigits=e,this.itemSeparator=i;}formatFloat(r){return this.allowAbbreviation?this.abbreviateFloat(r,this.maxAbbreviationError,this.fixedDigits):this.fixedDigits!==void 0?r.toFixed(this.fixedDigits):String(r)}abbreviateFloat(r,t=0,e=void 0){if(Math.abs(r)<t)return "0";if(r<0)return `-${this.abbreviateFloat(-r,t,e)}`;let i=D.matchUnicodeFraction(h=>Math.abs(h.value-r)<=t);if(i!==void 0)return i.character;let n=D.matchUnicodeFraction(h=>Math.abs(Math.sqrt(h.value)-r)<=t);return n!==void 0?`\u221A${n.character}`:r%1!==0&&e!==void 0?r.toFixed(e):r.toString()}};U.CONSISTENT=new U(!1,0,2,", "),U.EXACT=new U(!0,0,void 0,", "),U.MINIFIED=new U(!0,0,void 0,","),U.SIMPLIFIED=new U(!0,5e-4,3,", ");var ct=U,ht=class J{static matchUnicodeFraction(r){for(let t of ft)if(r(t))return t}constructor(r,t,e,i=", "){this.allowAbbreviation=r,this.maxAbbreviationError=t,this.fixedDigits=e,this.itemSeparator=i;}format(r){return this.allowAbbreviation?this.abbreviateNumber(r,this.maxAbbreviationError,this.fixedDigits):this.fixedDigits!==void 0?r.toFixed(this.fixedDigits):String(r)}abbreviateNumber(r,t=0,e=void 0){if(Math.abs(r)<t)return "0";if(r<0)return `-${this.abbreviateNumber(-r,t,e)}`;let i=J.matchUnicodeFraction(h=>Math.abs(h.value-r)<=t);if(i!==void 0)return i.character;let n=J.matchUnicodeFraction(h=>Math.abs(Math.sqrt(h.value)-r)<=t);return n!==void 0?`\u221A${n.character}`:r%1!==0&&e!==void 0?r.toFixed(e):r.toString()}},Z={allowAbbreviation:!0,maxAbbreviationError:0,fixedDigits:void 0},P=class E{constructor(r,t){this.isEqualTo=this.eq.bind(this),this.isApproximatelyEqualTo=this.nearlyEq.bind(this),this.conj=this.conjugate.bind(this),this.plus=this.add.bind(this),this.subtract=this.sub.bind(this),this.minus=this.sub.bind(this),this.multiply=this.mult.bind(this),this.times=this.mult.bind(this),this.dividedBy=this.div.bind(this),this.magnitude=this.abs.bind(this),this.norm2=this.abs2.bind(this),this.angle=this.arg.bind(this),this.phase=this.arg.bind(this),this.real=r,this.imag=t,this.isApproximatelyEqualTo=this.nearlyEq,this.isEqualTo=this.eq,this.conj=this.conjugate,this.plus=this.add,this.subtract=this.sub,this.minus=this.sub,this.multiply=this.mult,this.times=this.mult,this.dividedBy=this.div,this.magnitude=this.abs,this.norm2=this.abs2,this.angle=this.arg,this.phase=this.arg;}static from(r){return typeof r=="number"?new E(r,0):r}static real(r){return typeof r=="number"?r:r.real}static imag(r){return typeof r=="number"?0:r.imag}static polar(r,t){let[e,i]=this.cosAndSin(t);return new E(r*e,r*i)}static cosAndSin(r){let t=Math.PI/4,e=Math.round(r/t);if(e*t===r){let i=Math.sqrt(.5);return [[1,0],[i,i],[0,1],[-i,i],[-1,0],[-i,-i],[0,-1],[i,-i]][e&7]}return [Math.cos(r),Math.sin(r)]}eq(r){return typeof r=="number"?this.real===r&&this.imag===0:r instanceof E?this.real===r.real&&this.imag===r.imag:!1}nearlyEq(r,t){if(typeof r=="number"||r instanceof E){let e=this.sub(E.from(r));return Math.abs(e.real)<=t&&Math.abs(e.imag)<=t&&e.abs()<=t}return !1}conjugate(){return new E(this.real,-this.imag)}neg(){return new E(-this.real,-this.imag)}add(r){let t=E.from(r);return new E(this.real+t.real,this.imag+t.imag)}sub(r){let t=E.from(r);return new E(this.real-t.real,this.imag-t.imag)}mult(r){let t=E.from(r);return new E(this.real*t.real-this.imag*t.imag,this.real*t.imag+this.imag*t.real)}div(r){let t=E.from(r),e=t.abs2();if(e===0)return S(Error("Division by Zero"));let i=this.mult(t.conjugate());return A(new E(i.real/e,i.imag/e))}abs(){return Math.sqrt(this.abs2())}abs2(){return this.real*this.real+this.imag*this.imag}arg(){return Math.atan2(this.imag,this.real)}pow(r){return r===.5&&this.imag===0&&this.real>=0?new E(Math.sqrt(this.real),0):this.eq(E.ZERO)?E.ZERO:this.ln().mult(E.from(r)).exp()}exp(){return E.polar(Math.exp(this.real),this.imag)}format(r=Z){let t=new ht(r.allowAbbreviation===void 0?Z.allowAbbreviation:r.allowAbbreviation,r.maxAbbreviationError||0,r.fixedDigits);return t.allowAbbreviation?this.toStringAllowSingleValue(t):this.toStringBothValues(t)}toString(){let r=new ht(Z.allowAbbreviation,Z.maxAbbreviationError,Z.fixedDigits);return this.toStringAllowSingleValue(r)}ln(){return new E(Math.log(this.abs()),this.arg())}toStringAllowSingleValue(r){if(this.canImagPartBeOmitted(r.maxAbbreviationError))return r.format(this.real);if(this.canRealPartBeOmitted(r.maxAbbreviationError)){let t;return this.isImagFactorCloseToOne(r.maxAbbreviationError)?t="":this.isImagFactorMinusOne(r.maxAbbreviationError)?t="-":t=r.format(this.imag),`${t}i`}return this.toStringBothValues(r)}toStringBothValues(r){let t=this.imag>=0?"+":"-",e=this.canImagFactorBeOmitted(r)?"":r.format(Math.abs(this.imag));return `${(r.allowAbbreviation||r.fixedDigits===void 0||this.real<0?"":"+")+r.format(this.real)+t+e}i`}canRealPartBeOmitted(r){return Math.abs(this.real)<=r}canImagPartBeOmitted(r){return Math.abs(this.imag)<=r}isImagFactorCloseToOne(r){return Math.abs(this.imag-1)<=r}isImagFactorMinusOne(r){return Math.abs(this.imag+1)<=r}canImagFactorBeOmitted(r){return r.allowAbbreviation&&Math.abs(Math.abs(this.imag)-1)<=r.maxAbbreviationError}};P.ZERO=new P(0,0),P.ONE=new P(1,0),P.I=new P(0,1);var k=P;var hr=()=>({message:"Parse Error"}),mt=class pt{static need(r,t,e){if(r!==!0){let i=e===void 0?"(not provided)":`[${Array.prototype.slice.call(e).join(", ")}]`,n=`Precondition failed

Message: ${t===void 0?"(not provided)":t}

Args: ${i}`;throw new Error(n)}}static notNull(r){pt.need(r!=null,"notNull");}static get urlJson(){let r=new URL(location.href,window.location.origin),t=decodeURIComponent(r.pathname),e=t.lastIndexOf("/");return t.substring(e+1)}};mt.safeJsonParse=V.fromThrowable(JSON.parse,hr);var z=mt;var dt="Bloch",bt="\u2022",gt="H",wt="Measure",vt="P",yt="QFT\u2020",xt="QFT",St="X^\xBD",Mt="Rx",Et="Ry",At="Rz",Tt="S\u2020",Ct="S",kt="\u2026",Ot="Swap",Nt="T\u2020",zt="T",Gt="|0>",Ut="|1>",Dt="X",Ft="Y",Rt="Z";var lr={allowAbbreviation:!0,maxAbbreviationError:5e-4,fixedDigits:void 0,itemSeparator:", "},x=class s{constructor(r,t,e){this.plus=this.add.bind(this);this.height=r,this.width=t,this.buffer=e,this.plus=this.add;}static rows(r){let t=r.length;if(t===0)return S(Error("rows is empty"));let e=r[0].length;return r[0].length===0?S(Error("rows[0] is empty")):s.build(t,e,(i,n)=>r[i][n])}static column_vector(...r){return s.build(r.length,1,t=>r[t])}static build(r,t,e){let i=new Float64Array(t*r*2);for(let n=0;n<r;n++)for(let h=0;h<t;h++){let b=(n*t+h)*2,y=b+1,f;e?f=k.from(e(n,h)):f=k.from(0),i[b]=f.real,i[y]=f.imag;}return s.create(r,t,i)}static create(r,t,e){return t<0?S(Error(`width(${t}) < 0`)):r<0?S(Error(`height(${r}) < 0`)):t*r*2!==e.length?S(Error(`width(${t})*height(${r})*2 !== buffer.length(${e.length})`)):A(new s(r,t,e))}element(r,t){if(r<0||t<0||r>=this.height||t>=this.width)return S(Error("Element out of range"));let e=(this.width*r+t)*2,i=e+1;return A(new k(this.buffer[e],this.buffer[i]))}set(r,t,e){if(r<0||t<0||r>=this.height||t>=this.width)return S(Error("Element out of range"));let i=(this.width*r+t)*2,n=i+1;return this.buffer[i]=e.real,this.buffer[n]=e.imag,A(this)}column(r){if(r<0)return S(Error("colIndex < 0"));if(r>this.width)return S(Error("colIndex > this.width"));let t=[];for(let e=0;e<this.height;e++){let i=this.element(e,r);if(i.isErr())return S(i.error);t.push(i.value);}return A(t)}add(r){if(r.width!==this.width||r.height!==this.height)return S(Error("Incompatible sizes"));let t=new Float64Array(this.buffer.length);for(let e=0;e<t.length;e++)t[e]=this.buffer[e]+r.buffer[e];return A(new s(this.height,this.width,t))}sub(r){if(r.width!==this.width||r.height!==this.height)return S(Error("Incompatible sizes"));let t=new Float64Array(this.buffer.length);for(let e=0;e<t.length;e++)t[e]=this.buffer[e]-r.buffer[e];return A(new s(this.height,this.width,t))}mult(r){return r instanceof s?this.multMatrix(r):A(this.multScalar(r))}applyControlledGate(r,t,e=[],i=[]){let{width:n,height:h,buffer:b}=this;for(let M of e)z.need(M>=0,"control bit out of range"),z.need(h>=2<<M,"control bit out of range");for(let M of i)z.need(M>=0,"anti control bit out of range"),z.need(h>=2<<M,"anti control bit out of range");let y=e.concat(i).reduce((M,T)=>M|1<<T,0),f=e.reduce((M,T)=>M|1<<T,0);z.need((f&1<<t)===0,"Matrix.timesQubitOperation: self-controlled"),z.need(r.width===2&&r.height===2,"Matrix.timesQubitOperation: not 2x2");let[w,d,a,o,u,l,c,v]=r.buffer;z.need(t>=0,"target bit out of range"),z.need(h>=2<<t,"target bit out of range");let g=new Float64Array(b),N=0;for(let M=0;M<h;M++){let T=(M&1<<t)!==0,m=(y&M^f)===0;for(let p=0;p<n;p++){if(m&&!T){let O=N+(1<<t)*2*n,C=g[N],G=g[N+1],F=g[O],L=g[O+1];g[N]=C*w-G*d+F*a-L*o,g[N+1]=C*d+G*w+F*o+L*a,g[O]=C*u-G*l+F*c-L*v,g[O+1]=C*l+G*u+F*v+L*c;}N+=2;}}return s.create(h,n,g)._unsafeUnwrap()}timesQubitOperation(r,t,e){z.need((e&1<<t)===0,"Matrix.timesQubitOperation: self-controlled"),z.need(r.width===2&&r.height===2,"Matrix.timesQubitOperation: not 2x2");let{width:i,height:n,buffer:h}=this,[b,y,f,w,d,a,o,u]=r.buffer;z.need(n>=2<<t,"Matrix.timesQubitOperation: qubit index out of range");let l=new Float64Array(h),c=0;for(let v=0;v<n;v++){let g=(e&v^e)!==0,N=(v&1<<t)!==0;for(let M=0;M<i;M++){if(!g&&!N){let T=c+(1<<t)*2*i,m=l[c],p=l[c+1],O=l[T],C=l[T+1];l[c]=m*b-p*y+O*f-C*w,l[c+1]=m*y+p*b+O*w+C*f,l[T]=m*d-p*a+O*o-C*u,l[T+1]=m*a+p*d+O*u+C*o;}c+=2;}}return s.create(n,i,l)._unsafeUnwrap()}rows(){return range(0,this.height-1).map(r=>range(0,this.width-1).map(t=>this.element(r,t)._unsafeUnwrap()))}isHermitian(r=0){if(this.width!==this.height)return !1;for(let t=0;t<this.width;t++)for(let e=0;e<this.height;e++){let i=(this.width*e+t)*2,n=(this.width*t+e)*2;if(Math.abs(this.buffer[i]-this.buffer[n])>r||Math.abs(this.buffer[i+1]+this.buffer[n+1])>r)return !1}return !0}trace(){let r=0,t=0,e=this.width*2+2;for(let i=0;i<this.buffer.length;i+=e)r+=this.buffer[i],t+=this.buffer[i+1];return new k(r,t)}adjoint(){let r=this.height,t=this.width,e=new Float64Array(r*t*2);for(let i=0;i<t;i++)for(let n=0;n<r;n++){let h=(n*this.width+i)*2,b=(i*r+n)*2;e[b]=this.buffer[h],e[b+1]=-this.buffer[h+1];}return new s(t,r,e)}tensorProduct(r){let t=this.width,e=this.height,i=r.width,n=r.height,h=t*i,b=e*n,y=new Float64Array(h*b*2);for(let f=0;f<e;f++)for(let w=0;w<n;w++)for(let d=0;d<t;d++)for(let a=0;a<i;a++){let o=(f*t+d)*2,u=(w*i+a)*2,l=((f*n+w)*h+(d*i+a))*2,c=this.buffer[o],v=this.buffer[o+1],g=r.buffer[u],N=r.buffer[u+1],M=c*g-v*N,T=c*N+v*g;y[l]=M,y[l+1]=T;}return new s(b,h,y)}eq(r){if(this===r)return !0;if(!(r instanceof s))return !1;let t=r;return this.width===t.width&&this.height===t.height&&range(0,this.buffer.length-1).every(e=>this.buffer[e]===t.buffer[e])}nearlyEq(r,t){return r instanceof s&&this.width===r.width&&this.height===r.height&&Math.sqrt(this.sub(r)._unsafeUnwrap().norm2())<=t}format(r=lr){let t=new ct(r.allowAbbreviation===void 0?!0:r.allowAbbreviation,r.maxAbbreviationError||0,r.fixedDigits,r.itemSeparator||", ");return `{{${this.rows().map(i=>i.map(n=>n.format(t)).join(t.itemSeparator)).join(`}${t.itemSeparator}{`)}}}`}toString(){return this.format()}qubitDensityMatrixToBlochVector(){if(this.width!==2||this.height!==2)throw new Error("Need a 2x2 density matrix.");if(!this.isHermitian(.01))throw new Error("Density matrix should be Hermitian.");if(!this.trace().nearlyEq(1,.01))throw new Error("Density matrix should have unit trace.");let[r,t,e,i,n,h,b,y]=this.buffer,f=n+e,w=h-i,d=r-b;return [f,w,d]}clone(){return new s(this.height,this.width,this.buffer.slice())}norm2(){let r=0;for(let t of this.buffer)r+=t*t;return r}multMatrix(r){if(this.width!==r.height)return S(Error("Incompatible sizes."));let t=r.width,e=this.height,i=this.width,n=new Float64Array(t*e*2);for(let h=0;h<e;h++)for(let b=0;b<t;b++){let y=(h*t+b)*2;for(let f=0;f<i;f++){let w=(h*i+f)*2,d=(f*t+b)*2,a=this.buffer[w],o=this.buffer[w+1],u=r.buffer[d],l=r.buffer[d+1],c=a*u-o*l,v=a*l+u*o;n[y]+=c,n[y+1]+=v;}}return A(new s(e,t,n))}multScalar(r){let t=new Float64Array(this.buffer.length),e=k.real(r),i=k.imag(r);for(let n=0;n<t.length;n+=2){let h=this.buffer[n],b=this.buffer[n+1];t[n]=h*e-b*i,t[n+1]=h*i+b*e;}return new s(this.height,this.width,t)}};var R=k.I,$=R.neg(),Bt=x.rows([[1,1],[1,-1]])._unsafeUnwrap().mult(Math.sqrt(.5))._unsafeUnwrap(),qt=x.rows([[0,1],[1,0]])._unsafeUnwrap(),_t=x.rows([[0,$],[R,0]])._unsafeUnwrap(),Pt=x.rows([[1,0],[0,-1]])._unsafeUnwrap(),tt=x.rows([[1,0],[0,R]])._unsafeUnwrap(),It=tt.adjoint(),rt=x.rows([[1,0],[0,R.times(Math.PI/4).exp()]])._unsafeUnwrap(),$t=rt.adjoint();function Vt(s){let r=j(s);return x.rows([[1,0],[0,R.times(r).exp()]])._unsafeUnwrap()}var Zt=x.rows([[R.plus(1),$.plus(1)],[$.plus(1),R.plus(1)]])._unsafeUnwrap().mult(.5)._unsafeUnwrap();function jt(s){let r=j(s),t=Math.cos(r/2),e=Math.sin(r/2);return x.rows([[t,$.times(e)],[$.times(e),t]])._unsafeUnwrap()}function Lt(s){let r=j(s),t=Math.cos(r/2),e=Math.sin(r/2);return x.rows([[t,-e],[e,t]])._unsafeUnwrap()}function Qt(s){let r=j(s);return x.rows([[$.times(r/2).exp(),0],[0,R.times(r/2).exp()]])._unsafeUnwrap()}var W=class s{constructor(r){this.toWolfram=this.toString.bind(this);typeof r=="string"?/^.*\|.+>$/.test(r)?this.matrix=this.ketstringToMatrix(r):this.matrix=this.bitstringToMatrix(r):this.matrix=r,this.size=this.matrix.height,this.nqubit=Math.log2(this.size),this.toWolfram=this.toString;}get bra(){return this.matrix.adjoint()}get ket(){return this.matrix}amplifier(r){return this.matrix.element(r,0)._unsafeUnwrap()}setAmplifier(r,t){let e=this.matrix.set(r,0,t);return e.isErr()?S(Error(e.error.message)):A(this)}blochVector(r){return this.qubitDensityMatrix(r).qubitDensityMatrixToBlochVector()}isApproximatelyEqualTo(r,t){return r instanceof s&&this.matrix.nearlyEq(r.matrix,t)}applyControlledGate(r,t,e=[],i=[]){return this.matrix=this.matrix.applyControlledGate(r,t,e,i),this.matrix}timesQubitOperation(r,t,e){return this.matrix=this.matrix.timesQubitOperation(r,t,e),this.matrix}toString(){return this.matrix.toString()}bitstringToMatrix(r){let t=!1,e="",i=[],n=new Error(`Invalid StateVector bit string: ${r}`);for(let h of r.split(""))switch(h){case"0":{if(t)throw n;i.push(x.column_vector(1,0)._unsafeUnwrap());break}case"1":{if(t)throw n;i.push(x.column_vector(0,1)._unsafeUnwrap());break}case"+":{if(t)throw n;i.push(x.column_vector(1,1)._unsafeUnwrap().mult(Math.sqrt(.5))._unsafeUnwrap());break}case"-":{t?e+="-":i.push(x.column_vector(1,-1)._unsafeUnwrap().mult(Math.sqrt(.5))._unsafeUnwrap());break}case"i":{t?e+="i":i.push(x.column_vector(1,new k(0,1))._unsafeUnwrap().mult(Math.sqrt(.5))._unsafeUnwrap());break}case"(":{if(t)throw n;t=!0,e="";break}case")":{if(!t||e!=="-i")throw n;i.push(x.column_vector(1,new k(0,-1))._unsafeUnwrap().mult(Math.sqrt(.5))._unsafeUnwrap()),t=!1;break}default:throw n}if(i.length===0)throw n;return i.reduce((h,b)=>h.tensorProduct(b))}ketstringToMatrix(r){let t=r.match(/^(.*)\|(.+)>$/);if(t===null)throw new Error(`ketString: invalid ket ${r}`);let e=t[1],i=t[2];if(e==="")return this.bitstringToMatrix(i);{let n;if(e==="-")n=-1;else if(e==="i")n=k.I;else if(e==="-i")n=k.I.times(-1);else throw new Error(`ketString: invalid coef ${e}`);let h=new s(i).matrix.mult(n);if(h.isErr())throw new Error(`ketString: invalid ket ${i}`);return h.value}}qubitDensityMatrix(r){if(r<0||r>=this.nqubit)throw new Error(`Qubit index out of range: ${r}`);let t=[...Array(Math.log2(this.matrix.height)).keys()].filter(n=>n!==r),e=(n,h)=>h.sort().reverse().reduce((b,y)=>{let f=b>>y+1;f=f<<y;let w=(1<<y)-1&b;return f|w},n),i=x.build(2,2)._unsafeUnwrap();for(let n=0;n<this.matrix.height;n++)for(let h=0;h<this.matrix.height;h++){if(!t.every(a=>(n>>a&1)===(h>>a&1)))continue;let y=this.matrix.element(h,0)._unsafeUnwrap().times(this.matrix.element(n,0)._unsafeUnwrap().conjugate());if(y.isEqualTo(0))continue;let f=e(h,t)===0?x.column_vector(1,0)._unsafeUnwrap():x.column_vector(0,1)._unsafeUnwrap(),w=e(n,t)===0?x.rows([[1,0]])._unsafeUnwrap():x.rows([[0,1]])._unsafeUnwrap(),d=f.mult(w)._unsafeUnwrap();i=i.add(d.mult(y)._unsafeUnwrap())._unsafeUnwrap();}return i}};function Wt(s,r){return Math.round(s*Math.pow(10,r))/Math.pow(10,r)}var Xt=class{constructor(r){this.state=new W(r),this.measuredBits={},this.flags={},this.blochVectors={};}runStep(r){this.blochVectors={};for(let t of r)switch(t.type){case gt:if(t.if&&!this.flags[t.if])break;this.h(...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case Dt:if(t.if&&!this.flags[t.if])break;this.x(...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case Ft:if(t.if&&!this.flags[t.if])break;this.y(...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case Rt:if(t.if&&!this.flags[t.if])break;this.z(...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case St:if(t.if&&!this.flags[t.if])break;this.rnot(...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case Ct:{if(t.if&&!this.flags[t.if])break;this.s(...t.targets,{controls:t.controls,antiControls:t.antiControls});break}case Tt:{if(t.if&&!this.flags[t.if])break;this.sDagger(...t.targets,{controls:t.controls,antiControls:t.antiControls});break}case zt:{if(t.if&&!this.flags[t.if])break;this.t(...t.targets,{controls:t.controls,antiControls:t.antiControls});break}case Nt:{if(t.if&&!this.flags[t.if])break;this.tDagger(...t.targets,{controls:t.controls,antiControls:t.antiControls});break}case vt:{if(!t.angle)throw new Error("angle is not set");if(t.if&&!this.flags[t.if])break;this.phase(t.angle,...t.targets,{controls:t.controls,antiControls:t.antiControls});break}case Mt:if(!t.angle)throw new Error("angle is not set");if(t.if&&!this.flags[t.if])break;this.rx(t.angle,...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case Et:if(!t.angle)throw new Error("angle is not set");if(t.if&&!this.flags[t.if])break;this.ry(t.angle,...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case At:if(!t.angle)throw new Error("angle is not set");if(t.if&&!this.flags[t.if])break;this.rz(t.angle,...t.targets,{controls:t.controls,antiControls:t.antiControls});break;case Ot:{this.swap(t.targets[0],t.targets[1],{controls:t.controls});break}case bt:{this.z(t.targets[0],{controls:t.targets.slice(1)});break}case dt:for(let e of t.targets)this.blochDisplay(e);break;case Gt:this.write(0,...t.targets);break;case Ut:this.write(1,...t.targets);break;case wt:for(let e of t.targets)this.measure(e),t.flag&&(this.flags[t.flag]=this.measuredBits[e]===1);break;case kt:break;case xt:this.qft(t.span,...t.targets);break;case yt:this.qftDagger(t.span,...t.targets);break;default:throw new Error("Unknown instruction")}return this}h(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(Bt,t,e),this}x(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(qt,t,e),this}y(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(_t,t,e),this}z(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(Pt,t,e),this}rnot(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(Zt,t,e),this}s(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(tt,t,e),this}sDagger(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(It,t,e),this}t(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu(rt,t,e),this}tDagger(...r){let{targets:t,controlOptions:e}=this.processGateArgs(r);return this.cu($t,t,e),this}phase(r,...t){let{targets:e,controlOptions:i}=this.processGateArgs(t);return this.cu(Vt(r),e,i),this}rx(r,...t){let{targets:e,controlOptions:i}=this.processGateArgs(t);return this.cu(jt(r),e,i),this}ry(r,...t){let{targets:e,controlOptions:i}=this.processGateArgs(t);return this.cu(Lt(r),e,i),this}rz(r,...t){let{targets:e,controlOptions:i}=this.processGateArgs(t);return this.cu(Qt(r),e,i),this}swap(r,t,e){let i=(e==null?void 0:e.controls)||[];return this.x(t,{controls:i.concat([r])}).x(r,{controls:i.concat([t])}).x(t,{controls:i.concat([r])}),this}blochDisplay(r){let[t,e,i]=this.state.blochVector(r);return this.blochVectors[r]={x:t,y:e,z:i},this}write(r,...t){for(let e of t){let i=Wt(this.pZero(e),5);(r===0&&i===0||r===1&&i===1)&&this.x(e);}return this}measure(...r){for(let t of r){let e=this.pZero(t);if(Math.random()<=e){for(let n=0;n<1<<this.state.nqubit;n++){n&1<<t&&this.state.setAmplifier(n,k.ZERO);let h=this.state.amplifier(n).div(Math.sqrt(e));if(h.isErr())throw Error(h.error.message);this.state.setAmplifier(n,h.value);}this.measuredBits[t]=0;}else {for(let n=0;n<1<<this.state.nqubit;n++){n&1<<t||this.state.setAmplifier(n,k.ZERO);let h=this.state.amplifier(n).div(Math.sqrt(1-e));if(h.isErr())throw Error(h.error.message);this.state.setAmplifier(n,h.value);}this.measuredBits[t]=1;}}return this}qft(r,...t){for(let e of t)this.qftSingleTargetBit(r,e);return this}qftDagger(r,...t){for(let e of t)this.qftDaggerSingleTargetBit(r,e);return this}qftSingleTargetBit(r,t){for(let e=0;e<r;e++){this.h(t+e);for(let i=1;i<r-e;i++)this.phase(`\u03C0/${2**i}`,t+e,{controls:[t+e+i]});}return this}qftDaggerSingleTargetBit(r,t){for(let e=r-1;e>=0;e--){for(let i=r-e-1;i>0;i--)this.phase(`-\u03C0/${2**i}`,t+e,{controls:[t+e+i]});this.h(t+e);}return this}processGateArgs(r){let t=typeof r[r.length-1]=="object"?r.pop():{};return {targets:r,controlOptions:t}}cu(r,t,e){for(let i of t)this.state.applyControlledGate(r,i,e.controls,e.antiControls);}pZero(r){let t=0;for(let e=0;e<1<<this.state.nqubit;e++)e&1<<r||(t+=Math.pow(this.state.amplifier(e).abs(),2));return t}};/*! Bundled license information:

    fraction.js/fraction.js:
      (**
       * @license Fraction.js v4.2.0 05/03/2022
       * https://www.xarg.org/2014/03/rational-numbers-in-javascript/
       *
       * Copyright (c) 2021, Robert Eisele (robert@xarg.org)
       * Dual licensed under the MIT or GPL Version 2 licenses.
       **)
    */

    // Install SW
    self.addEventListener("install", function () {
        console.log("ServiceWorker installed");
    });
    // TODO: Qni の runSimulator にあたるハンドラを実行
    self.addEventListener("message", function (event) {
        var circuitJson = event.data.circuitJson;
        var qubitCount = event.data.qubitCount;
        var stepIndex = event.data.stepIndex;
        var targets = event.data.targets;
        var steps = event.data.steps;
        var simulator = new Xt("0".repeat(qubitCount));
        var vector = simulator.state.matrix.clone();
        var amplitudes = [];
        for (var i = 0; i < vector.height; i++) {
            var c = vector.element(0, i);
            if (c.isOk()) {
                amplitudes.push([c.value.real, c.value.imag]);
            }
        }
        // バックエンドを呼ぶ
        function call_backend() {
            return __awaiter(this, void 0, void 0, function () {
                var params, response, jsondata, i, stepResult, error_1;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            _a.trys.push([0, 3, , 4]);
                            params = new URLSearchParams({
                                id: circuitJson,
                                qubitCount: qubitCount,
                                stepIndex: stepIndex,
                                targets: targets,
                                steps: JSON.stringify(steps),
                            });
                            return [4 /*yield*/, fetch("http://localhost:8000/backend.json", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/x-www-form-urlencoded", // URLSearchParams を使用する場合
                                    },
                                    body: params.toString(), // パラメータをボディに設定
                                })];
                        case 1:
                            response = _a.sent();
                            if (!response.ok) {
                                if (response.status === 502) {
                                    console.error("502 Bad Gateway: The backend server is currently down. It is likely that the uWSGI server is down.");
                                }
                                else {
                                    console.error("HTTP error ".concat(response.status, ": ").concat(response.statusText));
                                }
                                throw new Error("Failed to connect to Qni's backend endpoint.");
                            }
                            return [4 /*yield*/, response.json()];
                        case 2:
                            jsondata = _a.sent();
                            for (i = 0; i < jsondata.length; i++) {
                                stepResult = jsondata[i];
                                self.postMessage({
                                    type: "step",
                                    step: i,
                                    amplitudes: stepResult["amplitudes"],
                                    blochVectors: stepResult["blochVectors"],
                                    measuredBits: stepResult["measuredBits"],
                                    flags: {},
                                });
                            }
                            return [3 /*break*/, 4];
                        case 3:
                            error_1 = _a.sent();
                            console.error(error_1);
                            return [3 /*break*/, 4];
                        case 4:
                            self.postMessage({ type: "finish" });
                            return [2 /*return*/];
                    }
                });
            });
        }
        call_backend();
    });

})();
//# sourceMappingURL=serviceWorker.js.map
